from dataclasses import dataclass
from enum import Enum
from typing import Optional

# 1. ƒê·ªãnh nghƒ©a Enum LoaiTaiKhoan theo TT99/2025/TT-BTC v√† Ph·ª• l·ª•c II
class LoaiTaiKhoan(str, Enum):  # üëà PH·∫¢I K·∫æ TH·ª™A str
    """
    Enum ƒë·∫°i di·ªán cho c√°c lo·∫°i t√†i kho·∫£n k·∫ø to√°n theo TT99/2025/TT-BTC Ph·ª• l·ª•c II.
    """
    TAI_SAN = "TAI_SAN"
    NO_PHAI_TRA = "NO_PHAI_TRA"
    VON_CHU_SO_HUU = "VON_CHU_SO_HUU"
    DOANH_THU = "DOANH_THU"
    THU_NHAP_KHAC = "THU_NHAP_KHAC"
    CHI_PHI = "CHI_PHI"
    GIA_VON = "GIA_VON"
    KHAC = "KHAC"

# 2. ƒê·ªãnh nghƒ©a Entity TaiKhoan s·ª≠ d·ª•ng dataclass
@dataclass
class TaiKhoan:
    """
    Entity ƒë·∫°i di·ªán cho T√†i kho·∫£n K·∫ø to√°n theo TT99/2025/TT-BTC Ph·ª• l·ª•c II.
    """
    so_tai_khoan: str
    ten_tai_khoan: str
    loai_tai_khoan: LoaiTaiKhoan
    cap_tai_khoan: int = 1
    so_tai_khoan_cha: Optional[str] = None
    la_tai_khoan_tong_hop: bool = True

    def kiem_tra_hop_le(self):
        """
        Ki·ªÉm tra h·ª£p l·ªá d·ª±a tr√™n c√°c quy t·∫Øc t·ª´ TT99/2025/TT-BTC.
        """
        if not self.so_tai_khoan or not self.so_tai_khoan.strip():
            raise ValueError("S·ªë t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng ho·∫∑c ch·ªâ c√≥ kho·∫£ng tr·∫Øng.")
        if not self.ten_tai_khoan or not self.ten_tai_khoan.strip():
            raise ValueError("T√™n t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng ho·∫∑c ch·ªâ c√≥ kho·∫£ng tr·∫Øng.")
        if len(self.so_tai_khoan) > 20:
            raise ValueError("S·ªë t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 20 k√Ω t·ª±.")
        if len(self.ten_tai_khoan) > 256:
            raise ValueError("T√™n t√†i kho·∫£n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 256 k√Ω t·ª±.")
        if self.cap_tai_khoan < 1 or self.cap_tai_khoan > 3:
            raise ValueError("C·∫•p t√†i kho·∫£n ph·∫£i t·ª´ 1 ƒë·∫øn 3 theo TT99/2025/TT-BTC Ph·ª• l·ª•c II.")
        if self.cap_tai_khoan > 1:
            if not self.so_tai_khoan_cha or not self.so_tai_khoan_cha.strip():
                raise ValueError(f"T√†i kho·∫£n c·∫•p con (C·∫•p {self.cap_tai_khoan}) ph·∫£i c√≥ s·ªë t√†i kho·∫£n cha.")

    def __post_init__(self):
        self.kiem_tra_hop_le()
from dataclasses import dataclass
from datetime import date
from typing import Optional

@dataclass
class KyKeToan:
    """
    Entity ƒë·∫°i di·ªán cho m·ªôt k·ª≥ k·∫ø to√°n (Accounting Period).
    Ch·ª©a c√°c thu·ªôc t√≠nh c∆° b·∫£n v√† quy t·∫Øc h·ª£p l·ªá c·ªßa m·ªôt k·ª≥ k·∫ø to√°n.
    """
    id: Optional[int] = None
    ten_ky: str = "" # T√™n ƒë·ªãnh danh k·ª≥ (V√≠ d·ª•: "Q1-2025", "NƒÉm 2025")
    ngay_bat_dau: date = date.today() # Ng√†y b·∫Øt ƒë·∫ßu c·ªßa k·ª≥ k·∫ø to√°n
    ngay_ket_thuc: date = date.today() # Ng√†y k·∫øt th√∫c c·ªßa k·ª≥ k·∫ø to√°n
    trang_thai: str = "Open" # Tr·∫°ng th√°i c·ªßa k·ª≥: "Open" (M·ªü), "Locked" (ƒê√£ kh√≥a)
    ghi_chu: str = ""

    def kiem_tra_hop_le(self):
        """
        [Nghi·ªáp v·ª•] Ki·ªÉm tra c√°c r√†ng bu·ªôc c∆° b·∫£n c·ªßa Entity KyKeToan.
        1. ƒê·∫£m b·∫£o t√™n k·ª≥ kh√¥ng tr·ªëng.
        2. ƒê·∫£m b·∫£o ng√†y b·∫Øt ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c sau ng√†y k·∫øt th√∫c.
        3. ƒê·∫£m b·∫£o tr·∫°ng th√°i k·ª≥ ch·ªâ l√† 'Open' ho·∫∑c 'Locked'.
        """
        if not self.ten_ky or not self.ten_ky.strip():
            raise ValueError("T√™n k·ª≥ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.")
        if self.ngay_bat_dau > self.ngay_ket_thuc:
            raise ValueError("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ sau ng√†y k·∫øt th√∫c.")
        if self.trang_thai not in ["Open", "Locked"]:
            raise ValueError("Tr·∫°ng th√°i k·ª≥ ph·∫£i l√† 'Open' ho·∫∑c 'Locked'.")

    def __post_init__(self):
        """
        H√†m ƒë∆∞·ª£c g·ªçi sau khi kh·ªüi t·∫°o ƒë·ªÉ t·ª± ƒë·ªông th·ª±c hi·ªán ki·ªÉm tra h·ª£p l·ªá
        ngay khi ƒë·ªëi t∆∞·ª£ng KyKeToan ƒë∆∞·ª£c t·∫°o ra.
        """
        self.kiem_tra_hop_le()
from dataclasses import dataclass, field
from datetime import date
from decimal import Decimal, ROUND_HALF_UP
from typing import List, Optional

# H·∫±ng s·ªë l√†m tr√≤n ti·ªÅn t·ªá (2 ch·ªØ s·ªë th·∫≠p ph√¢n)
SCALE = Decimal("0.01")


@dataclass(frozen=True)
class JournalEntryLine:
    """
    Value Object: M·ªôt d√≤ng trong b√∫t to√°n k·∫ø to√°n.
    Tu√¢n th·ªß TT99/2025/TT-BTC:
    - G·∫Øn ch·ª©ng t·ª´ g·ªëc (ƒêi·ªÅu 8, 9, 10; Ph·ª• l·ª•c I)
    - H·ªó tr·ª£ ƒëa ti·ªÅn t·ªá (ƒêi·ªÅu 4‚Äì6)
    - M√£ d√≤ng ti·ªÅn (cho B03-DN ‚Äì Ph·ª• l·ª•c IV)
    """
    so_tai_khoan: str

    no: Decimal = Decimal("0")
    co: Decimal = Decimal("0")

    # --- H·ªó tr·ª£ ƒëa ti·ªÅn t·ªá (ƒêi·ªÅu 4‚Äì6) ---
    so_tien_goc: Optional[Decimal] = None
    don_vi_tien_te_goc: Optional[str] = None
    ty_gia: Optional[Decimal] = None

    # --- G·∫Øn v·ªõi ch·ª©ng t·ª´ g·ªëc (ƒêi·ªÅu 8, 9; Ph·ª• l·ª•c I) ---
    so_chung_tu_goc: Optional[str] = None
    ngay_chung_tu_goc: Optional[date] = None
    loai_chung_tu: Optional[str] = None  # V√≠ d·ª•: '01-TT', '01-VT', '05-LƒêTL'

    # --- M√¥ t·∫£ & ph√¢n lo·∫°i d√≤ng ti·ªÅn (Ph·ª• l·ª•c IV ‚Äì B03-DN) ---
    mo_ta: Optional[str] = None
    ma_dong_tien: Optional[str] = None  # V√≠ d·ª•: 'HƒêKD', 'HƒêƒêT', 'HƒêTC'

    def __post_init__(self):
        # 1. Ki·ªÉm tra s·ªë ti·ªÅn kh√¥ng √¢m
        if self.no < 0 or self.co < 0:
            raise ValueError("S·ªë ti·ªÅn N·ª£/C√≥ kh√¥ng th·ªÉ √¢m.")

        # 2. Kh√¥ng ƒë∆∞·ª£c ghi c·∫£ N·ª£ v√† C√≥
        if self.no > 0 and self.co > 0:
            raise ValueError("M·ªói d√≤ng b√∫t to√°n ch·ªâ ƒë∆∞·ª£c ghi N·ª£ ho·∫∑c C√≥, kh√¥ng ƒë·ªìng th·ªùi c·∫£ hai.")

        # 3. D√≤ng b√∫t to√°n ph·∫£i c√≥ gi√° tr·ªã ph√°t sinh
        if self.no == 0 and self.co == 0:
            raise ValueError("D√≤ng b√∫t to√°n ph·∫£i c√≥ gi√° tr·ªã ph√°t sinh (N·ª£ ho·∫∑c C√≥ > 0).")

        # 4. Ki·ªÉm tra logic ƒëa ti·ªÅn t·ªá (n·∫øu c√≥)
        if self.so_tien_goc is not None:
            if not self.don_vi_tien_te_goc:
                raise ValueError("Thi·∫øu ƒë∆°n v·ªã ti·ªÅn t·ªá g·ªëc.")
            if self.ty_gia is None:
                raise ValueError("Thi·∫øu t·ª∑ gi√° chuy·ªÉn ƒë·ªïi.")
            if self.so_tien_goc < 0:
                raise ValueError("S·ªë ti·ªÅn g·ªëc kh√¥ng th·ªÉ √¢m.")

            # T√≠nh s·ªë ti·ªÅn quy ƒë·ªïi v√† so s√°nh (l√†m tr√≤n nh·∫•t qu√°n)
            expected = (self.so_tien_goc * self.ty_gia).quantize(SCALE, rounding=ROUND_HALF_UP)
            actual = max(self.no, self.co).quantize(SCALE, rounding=ROUND_HALF_UP)
            if expected != actual:
                raise ValueError(
                    f"S·ªë ti·ªÅn quy ƒë·ªïi ({expected}) kh√¥ng kh·ªõp v·ªõi N·ª£/C√≥ ({actual})."
                )


@dataclass
class JournalEntry:
    """
    Entity: B√∫t to√°n k·∫ø to√°n ‚Äî ch·ª©ng t·ª´ ghi nh·∫≠n nghi·ªáp v·ª• kinh t·∫ø.
    Tu√¢n th·ªß TT99: ph·∫£i c√¢n b·∫±ng N·ª£ = C√≥, c√≥ s·ªë phi·∫øu, ng√†y ch·ª©ng t·ª´, v√† √≠t nh·∫•t 2 d√≤ng.
    """
    id: Optional[int] = None
    ngay_ct: date = field(default_factory=date.today)
    so_phieu: str = ""
    mo_ta: str = ""
    lines: List[JournalEntryLine] = field(default_factory=list)
    trang_thai: str = "Draft"  # Draft, Posted, Locked

    def __post_init__(self):
        # 1. B·∫Øt bu·ªôc c√≥ √≠t nh·∫•t 2 d√≤ng (tu√¢n th·ªß nguy√™n t·∫Øc b√∫t to√°n k√©p ‚Äì TT99)
        if len(self.lines) < 2:
            raise ValueError("B√∫t to√°n ph·∫£i c√≥ √≠t nh·∫•t 2 d√≤ng (m·ªôt N·ª£, m·ªôt C√≥).")

        # 2. S·ªë phi·∫øu kh√¥ng ƒë∆∞·ª£c tr·ªëng
        if not self.so_phieu.strip():
            raise ValueError("S·ªë phi·∫øu kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.")

        # 3. Tr·∫°ng th√°i ph·∫£i h·ª£p l·ªá
        if self.trang_thai not in ("Draft", "Posted", "Locked"):
            raise ValueError(f"Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá: {self.trang_thai}")

        # 4. Ki·ªÉm tra c√¢n b·∫±ng N·ª£ = C√≥ (v·ªõi l√†m tr√≤n nh·∫•t qu√°n)
        tong_no = sum(line.no for line in self.lines).quantize(SCALE, rounding=ROUND_HALF_UP)
        tong_co = sum(line.co for line in self.lines).quantize(SCALE, rounding=ROUND_HALF_UP)
        if tong_no != tong_co:
            raise ValueError(f"B√∫t to√°n kh√¥ng c√¢n b·∫±ng. T·ªïng N·ª£: {tong_no}, T·ªïng C√≥: {tong_co}.")

    def set_trang_thai(self, trang_thai_moi: str):
        """C·∫≠p nh·∫≠t tr·∫°ng th√°i b√∫t to√°n (ch·ªâ cho ph√©p gi√° tr·ªã h·ª£p l·ªá)."""
        if trang_thai_moi not in ("Draft", "Posted", "Locked"):
            raise ValueError(f"Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá: {trang_thai_moi}")
        self.trang_thai = trang_thai_moi
from pydantic import BaseModel
from decimal import Decimal
from typing import List, Optional
from datetime import date

# --- C√°c Model cho B√°o c√°o t√†i ch√≠nh (DTOs) theo TT99/2025/TT-BTC (Ph·ª• l·ª•c IV) ---
# D·ªØ li·ªáu ƒë·∫ßu ra t·ª´ ReportingService -> API -> Client

# S·ª≠ d·ª•ng Decimal cho c√°c gi√° tr·ªã ti·ªÅn t·ªá ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c
# Default c√°c gi√° tr·ªã l√† Decimal(0)

class BaoCaoTaiChinhBase(BaseModel):
    """Model c∆° s·ªü cho c√°c b√°o c√°o t√†i ch√≠nh."""
    ngay_lap: date  # Ng√†y l·∫≠p b√°o c√°o
    ky_hieu: str    # K·ª≥ l·∫≠p b√°o c√°o (v√≠ d·ª•: "NƒÉm 2025", "Qu√Ω 4/2025")

# --- 1. B01-DN: B√°o c√°o t√¨nh h√¨nh t√†i ch√≠nh (Balance Sheet) ---
# C√°c ch·ªâ ti√™u chi ti·∫øt h∆°n theo Ph·ª• l·ª•c IV

# 1.1. T√ÄI S·∫¢N (ASSETS)
class TienVaCacKhoanTgTien(BaseModel):
    """M√£ s·ªë 110: Ti·ªÅn v√† c√°c kho·∫£n t∆∞∆°ng ƒë∆∞∆°ng ti·ªÅn"""
    tien_mat: Decimal = Decimal(0)
    tien_gui_ngan_hang: Decimal = Decimal(0)
    tien_dang_chuyen: Decimal = Decimal(0) # Th√™m ch·ªâ ti√™u n√†y n·∫øu c√≥
    tong_cong: Decimal = Decimal(0) # T·ªïng c·ªông 111 + 112 + 113 + ...

class TaiSanNganHan(BaseModel):
    """A. T√ÄI S·∫¢N NG·∫ÆN H·∫†N (M√£ s·ªë 100)"""
    tien_va_cac_khoan_tuong_duong_tien: TienVaCacKhoanTgTien
    cac_khoan_dau_tu_tai_chinh_ngan_han: Decimal = Decimal(0) # M√£ s·ªë 120
    cac_khoan_phai_thu_ngan_han: Decimal = Decimal(0)          # M√£ s·ªë 130
    hang_ton_kho: Decimal = Decimal(0)                       # M√£ s·ªë 140
    tai_san_ngan_han_khac: Decimal = Decimal(0)             # M√£ s·ªë 150
    tong_tai_san_ngan_han: Decimal = Decimal(0)              # M√£ s·ªë 100

class TaiSanDaiHan(BaseModel):
    """B. T√ÄI S·∫¢N D√ÄI H·∫†N (M√£ s·ªë 200)"""
    tai_san_co_dinh_huu_hinh: Decimal = Decimal(0)       # M√£ s·ªë 211
    tai_san_co_dinh_vo_hinh: Decimal = Decimal(0)        # M√£ s·ªë 221
    bat_dong_san_dau_tu: Decimal = Decimal(0)             # M√£ s·ªë 230
    cac_khoan_dau_tu_tai_chinh_dai_han: Decimal = Decimal(0) # M√£ s·ªë 250
    tai_san_dai_han_khac: Decimal = Decimal(0)            # M√£ s·ªë 260
    tong_tai_san_dai_han: Decimal = Decimal(0)             # M√£ s·ªë 200

class TongTaiSan(BaseModel):
    """T·ªïng c·ªông T√†i s·∫£n (M√£ s·ªë 270 = 100 + 200)"""
    tai_san_ngan_han: TaiSanNganHan
    tai_san_dai_han: TaiSanDaiHan
    tong_cong_tai_san: Decimal = Decimal(0)              # M√£ s·ªë 270

# 1.2. NGU·ªíN V·ªêN (LIABILITIES AND EQUITY)
class NoPhaiTraNganHan(BaseModel):
    """I. N·ª¢ PH·∫¢I TR·∫¢ NG·∫ÆN H·∫†N (M√£ s·ªë 300)"""
    vay_va_no_thue_tai_chinh_ngan_han: Decimal = Decimal(0)
    phai_tra_ngan_han_nguoi_ban: Decimal = Decimal(0)
    thue_va_cac_khoan_phai_nop_nha_nuoc: Decimal = Decimal(0)
    phai_tra_ngan_han_khac: Decimal = Decimal(0)
    tong_no_ngan_han: Decimal = Decimal(0)                   # M√£ s·ªë 300

class NoPhaiTraDaiHan(BaseModel):
    """II. N·ª¢ PH·∫¢I TR·∫¢ D√ÄI H·∫†N (M√£ s·ªë 400)"""
    vay_va_no_thue_tai_chinh_dai_han: Decimal = Decimal(0)
    du_phong_phai_tra_dai_han: Decimal = Decimal(0)
    tong_no_dai_han: Decimal = Decimal(0)                   # M√£ s·ªë 400

class VonChuSoHuu(BaseModel):
    """III. V·ªêN CH·ª¶ S·ªû H·ªÆU (M√£ s·ªë 500)"""
    von_dau_tu_cua_chu_so_huu: Decimal = Decimal(0)
    thang_du_von_co_phan: Decimal = Decimal(0)
    loi_nhuan_sau_thue_chua_phan_phoi: Decimal = Decimal(0)
    tong_von_chu_so_huu: Decimal = Decimal(0)                # M√£ s·ªë 500

class TongNguonVon(BaseModel):
    """T·ªïng c·ªông Ngu·ªìn v·ªën (M√£ s·ªë 430 = 300 + 400 + 500)"""
    no_phai_tra_ngan_han: NoPhaiTraNganHan
    no_phai_tra_dai_han: NoPhaiTraDaiHan
    von_chu_so_huu: VonChuSoHuu
    tong_cong_nguon_von: Decimal = Decimal(0)            # M√£ s·ªë 430

class BaoCaoTinhHinhTaiChinh(BaoCaoTaiChinhBase):
    """B01-DN: B√°o c√°o t√¨nh h√¨nh t√†i ch√≠nh (Balance Sheet)"""
    tai_san: TongTaiSan
    nguon_von: TongNguonVon
    # (Ki·ªÉm tra: tai_san.tong_cong_tai_san == nguon_von.tong_cong_nguon_von)


# --- 2. B02-DN: B√°o c√°o k·∫øt qu·∫£ ho·∫°t ƒë·ªông kinh doanh (Income Statement) ---

class BaoCaoKetQuaHDKD(BaoCaoTaiChinhBase):
    """B02-DN: B√°o c√°o k·∫øt qu·∫£ ho·∫°t ƒë·ªông kinh doanh (Income Statement)"""
    # 1. Doanh thu b√°n h√†ng v√† cung c·∫•p d·ªãch v·ª• (M√£ s·ªë 01)
    doanh_thu_ban_hang: Decimal = Decimal(0)
    # 2. C√°c kho·∫£n gi·∫£m tr·ª´ doanh thu (M√£ s·ªë 02) - Contra Revenue
    cac_khoan_giam_tru_doanh_thu: Decimal = Decimal(0)
    # 3. Doanh thu thu·∫ßn v·ªÅ b√°n h√†ng v√† cung c·∫•p d·ªãch v·ª• (M√£ s·ªë 10 = 01 - 02)
    doanh_thu_thuan: Decimal = Decimal(0)

    # 4. Gi√° v·ªën h√†ng b√°n (M√£ s·ªë 11)
    gia_von_hang_ban: Decimal = Decimal(0)
    # 5. L·ª£i nhu·∫≠n g·ªôp v·ªÅ b√°n h√†ng v√† cung c·∫•p d·ªãch v·ª• (M√£ s·ªë 20 = 10 - 11)
    loi_nhuan_gop: Decimal = Decimal(0)

    # 6. Doanh thu ho·∫°t ƒë·ªông t√†i ch√≠nh (M√£ s·ªë 21)
    doanh_thu_hoat_dong_tai_chinh: Decimal = Decimal(0)
    # 7. Chi ph√≠ t√†i ch√≠nh (M√£ s·ªë 22)
    chi_phi_tai_chinh: Decimal = Decimal(0)
    # 8. Chi ph√≠ b√°n h√†ng (M√£ s·ªë 25)
    chi_phi_ban_hang: Decimal = Decimal(0)
    # 9. Chi ph√≠ qu·∫£n l√Ω doanh nghi·ªáp (M√£ s·ªë 26)
    chi_phi_quan_ly_doanh_nghiep: Decimal = Decimal(0)

    # 10. L·ª£i nhu·∫≠n thu·∫ßn t·ª´ ho·∫°t ƒë·ªông kinh doanh (M√£ s·ªë 30 = 20 + 21 - 22 - 25 - 26)
    loi_nhuan_thuan_tu_hdkd: Decimal = Decimal(0)

    # 11. Thu nh·∫≠p kh√°c (M√£ s·ªë 31)
    thu_nhap_khac: Decimal = Decimal(0)
    # 12. Chi ph√≠ kh√°c (M√£ s·ªë 32)
    chi_phi_khac: Decimal = Decimal(0)
    # 13. L·ª£i nhu·∫≠n kh√°c (M√£ s·ªë 40 = 31 - 32)
    loi_nhuan_khac: Decimal = Decimal(0)

    # 14. T·ªïng l·ª£i nhu·∫≠n k·∫ø to√°n tr∆∞·ªõc thu·∫ø (M√£ s·ªë 50 = 30 + 40)
    tong_loi_nhuan_truoc_thue: Decimal = Decimal(0)
    # 15. Chi ph√≠ thu·∫ø thu nh·∫≠p doanh nghi·ªáp hi·ªán h√†nh (M√£ s·ªë 51)
    chi_phi_thue_thu_nhap_doanh_nghiep_hien_hanh: Decimal = Decimal(0)
    # 16. Chi ph√≠ thu·∫ø thu nh·∫≠p doanh nghi·ªáp ho√£n l·∫°i (M√£ s·ªë 52)
    chi_phi_thue_thu_nhap_doanh_nghiep_hoan_lai: Decimal = Decimal(0)

    # 17. L·ª£i nhu·∫≠n sau thu·∫ø thu nh·∫≠p doanh nghi·ªáp (M√£ s·ªë 60 = 50 - 51 - 52)
    loi_nhuan_sau_thue: Decimal = Decimal(0)


# --- 3. B03-DN: B√°o c√°o l∆∞u chuy·ªÉn ti·ªÅn t·ªá (Cash Flow Statement) ---
# Th∆∞·ªùng ƒë∆∞·ª£c l·∫≠p theo ph∆∞∆°ng ph√°p Gi√°n ti·∫øp (TT99 khuy·∫øn kh√≠ch)

class LuuChuyenTienTeHDKD(BaseModel):
    """L∆∞u chuy·ªÉn ti·ªÅn t·ª´ Ho·∫°t ƒë·ªông kinh doanh (M√£ s·ªë 20)"""
    loi_nhuan_truoc_thue: Decimal = Decimal(0)            # 01
    dieu_chinh_khau_hao_ts_co_dinh: Decimal = Decimal(0)   # 02
    dieu_chinh_cac_khoan_du_phong: Decimal = Decimal(0)     # 03
    dieu_chinh_lo_lai_chenh_lech_ty_gia: Decimal = Decimal(0) # 04
    tien_lai_phai_tra_chi_tra: Decimal = Decimal(0)          # 05
    # C√°c kho·∫£n ƒëi·ªÅu ch·ªânh kh√°c...
    tang_giam_cac_khoan_phai_thu: Decimal = Decimal(0)      # 06
    tang_giam_hang_ton_kho: Decimal = Decimal(0)           # 07
    tang_giam_cac_khoan_phai_tra: Decimal = Decimal(0)     # 08
    tien_chi_tra_lai_vay: Decimal = Decimal(0)             # 15
    tien_thue_thu_nhap_da_nop: Decimal = Decimal(0)        # 16
    luu_chuyen_tien_thuan_tu_hdkd: Decimal = Decimal(0)     # 20 (T·ªïng)

class LuuChuyenTienTeHDDT(BaseModel):
    """L∆∞u chuy·ªÉn ti·ªÅn t·ª´ Ho·∫°t ƒë·ªông ƒë·∫ßu t∆∞ (M√£ s·ªë 30)"""
    tien_chi_mua_sam_xay_dung_ts_dai_han: Decimal = Decimal(0) # 21
    tien_thu_thanh_ly_nhuong_ban_ts_dai_han: Decimal = Decimal(0) # 22
    tien_chi_cho_vay_mua_cac_cong_cu_no: Decimal = Decimal(0) # 24
    tien_thu_hoi_cho_vay_ban_lai_cac_cong_cu_no: Decimal = Decimal(0) # 25
    luu_chuyen_tien_thuan_tu_hddt: Decimal = Decimal(0)       # 30 (T·ªïng)

class LuuChuyenTienTeHDTC(BaseModel):
    """L∆∞u chuy·ªÉn ti·ªÅn t·ª´ Ho·∫°t ƒë·ªông t√†i ch√≠nh (M√£ s·ªë 40)"""
    tien_thu_tu_phat_hanh_co_phieu: Decimal = Decimal(0)       # 31
    tien_thu_tu_vay: Decimal = Decimal(0)                     # 32
    tien_chi_tra_goc_vay: Decimal = Decimal(0)                # 33
    tien_chi_tra_co_tuc_loi_nhuan: Decimal = Decimal(0)      # 36
    luu_chuyen_tien_thuan_tu_hdtc: Decimal = Decimal(0)      # 40 (T·ªïng)

class BaoCaoLuuChuyenTienTe(BaoCaoTaiChinhBase):
    """B03-DN: B√°o c√°o l∆∞u chuy·ªÉn ti·ªÅn t·ªá (Cash Flow Statement)"""
    luu_chuyen_tien_te_hdkd: LuuChuyenTienTeHDKD
    luu_chuyen_tien_te_hddt: LuuChuyenTienTeHDDT
    luu_chuyen_tien_te_hdtc: LuuChuyenTienTeHDTC
    # L∆∞u chuy·ªÉn ti·ªÅn thu·∫ßn trong k·ª≥ (M√£ s·ªë 50 = 20 + 30 + 40)
    luu_chuyen_tien_thuan_trong_ky: Decimal = Decimal(0)

    # Ti·ªÅn v√† t∆∞∆°ng ƒë∆∞∆°ng ti·ªÅn ƒë·∫ßu k·ª≥ (M√£ s·ªë 60)
    tien_va_tuong_duong_tien_dau_ky: Decimal = Decimal(0)
    # ·∫¢nh h∆∞·ªüng c·ªßa thay ƒë·ªïi t·ª∑ gi√° h·ªëi ƒëo√°i quy ƒë·ªïi ngo·∫°i t·ªá (M√£ s·ªë 61)
    anh_huong_thay_doi_ty_gia: Decimal = Decimal(0)

    # Ti·ªÅn v√† t∆∞∆°ng ƒë∆∞∆°ng ti·ªÅn cu·ªëi k·ª≥ (M√£ s·ªë 70 = 50 + 60 + 61)
    tien_va_tuong_duong_tien_cuoi_ky: Decimal = Decimal(0)


# --- 4. B09-DN: B·∫£n thuy·∫øt minh B√°o c√°o t√†i ch√≠nh (Model ƒë∆°n gi·∫£n h√≥a) ---
class ChiTietTaiKhoan(BaseModel):
    """Chi ti·∫øt v·ªÅ s·ªë d∆∞ v√† ph√°t sinh c·ªßa m·ªôt t√†i kho·∫£n c·ª• th·ªÉ"""
    so_tai_khoan: str
    ten_tai_khoan: str
    so_du_dau_ky_no: Decimal = Decimal(0) # S·ªë d∆∞ ƒë·∫ßu k·ª≥ b√™n N·ª£
    so_du_dau_ky_co: Decimal = Decimal(0) # S·ªë d∆∞ ƒë·∫ßu k·ª≥ b√™n C√≥
    phat_sinh_no: Decimal = Decimal(0)
    phat_sinh_co: Decimal = Decimal(0)
    so_du_cuoi_ky_no: Decimal = Decimal(0) # S·ªë d∆∞ cu·ªëi k·ª≥ b√™n N·ª£
    so_du_cuoi_ky_co: Decimal = Decimal(0) # S·ªë d∆∞ cu·ªëi k·ª≥ b√™n C√≥

class ThuyetMinhTaiSan(BaseModel):
    """Chi ti·∫øt thuy·∫øt minh v·ªÅ nh√≥m T√†i s·∫£n (v√≠ d·ª•: H√†ng t·ªìn kho, TSCƒê)"""
    tong_cong_thuyet_minh: Decimal = Decimal(0) # T·ªïng gi√° tr·ªã
    chi_tiet_tai_khoan: List[ChiTietTaiKhoan]
    ghi_chu_quan_trong: str = "T√≥m t·∫Øt c√°c ch√≠nh s√°ch k·∫ø to√°n li√™n quan ƒë·∫øn T√†i s·∫£n."

class ThuyetMinhNguonVon(BaseModel):
    """Chi ti·∫øt thuy·∫øt minh v·ªÅ nh√≥m Ngu·ªìn v·ªën (v√≠ d·ª•: N·ª£ ph·∫£i tr·∫£, V·ªën CSH)"""
    tong_cong_thuyet_minh: Decimal = Decimal(0) # T·ªïng gi√° tr·ªã
    chi_tiet_tai_khoan: List[ChiTietTaiKhoan]
    ghi_chu_quan_trong: str = "T√≥m t·∫Øt c√°c ch√≠nh s√°ch k·∫ø to√°n li√™n quan ƒë·∫øn Ngu·ªìn v·ªën."

class ThuyetMinhKetQua(BaseModel):
    """Chi ti·∫øt thuy·∫øt minh v·ªÅ nh√≥m K·∫øt qu·∫£ HƒêKD (v√≠ d·ª•: Doanh thu, Chi ph√≠)"""
    tong_doanh_thu: Decimal = Decimal(0)
    tong_chi_phi: Decimal = Decimal(0)
    chi_tiet_tai_khoan: List[ChiTietTaiKhoan]
    ghi_chu_quan_trong: str = "Gi·∫£i th√≠ch c√°c bi·∫øn ƒë·ªông l·ªõn trong doanh thu v√† chi ph√≠."


class BaoCaoThuyetMinh(BaoCaoTaiChinhBase):
    """B09-DN: B·∫£n thuy·∫øt minh B√°o c√°o t√†i ch√≠nh (Notes to Financial Statements)"""
    # C√°c th√¥ng tin chung
    dac_diem_hoat_dong_cua_doanh_nghiep: str
    ky_ke_toan_va_don_vi_tien_te: str
    chuan_muc_ke_toan_ap_dung: str = "VAS v√† TT99/2025/TT-BTC"

    # Chi ti·∫øt thuy·∫øt minh theo c√°c nh√≥m ch√≠nh
    thuyet_minh_tai_san: ThuyetMinhTaiSan
    thuyet_minh_nguon_von: ThuyetMinhNguonVon
    thuyet_minh_ket_qua_hoat_dong_kinh_doanh: ThuyetMinhKetQua

    # C√°c thuy·∫øt minh kh√°c
    thong_tin_giao_dich_voi_cac_ben_lien_quan: str = "Kh√¥ng c√≥"
    cac_su_kien_sau_ngay_ket_thuc_ky_ke_toan: str = "Kh√¥ng c√≥"
    # ... (c√°c ph·∫ßn kh√°c c·ªßa thuy·∫øt minh)
