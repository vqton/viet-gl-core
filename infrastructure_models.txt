# File: app/infrastructure/models/sql_account.py
from sqlalchemy import Column, String, Integer, Boolean, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.types import Enum as SQLEnum

from app.infrastructure.base import Base
from app.domain.models.account import LoaiTaiKhoan   # enum, KHÔNG phải entity


class SQLAccount(Base):
    """
    ORM Model đại diện bảng 'accounts'.
    """
    __tablename__ = "accounts"

    # Primary key
    so_tai_khoan = Column(String(20), primary_key=True, index=True)

    # Columns
    ten_tai_khoan = Column(String(256), nullable=False)
    loai_tai_khoan = Column(SQLEnum(LoaiTaiKhoan), nullable=False)
    cap_tai_khoan = Column(Integer, nullable=False, default=1)

    so_tai_khoan_cha = Column(String(20), ForeignKey("accounts.so_tai_khoan"), nullable=True)
    la_tai_khoan_tong_hop = Column(Boolean, nullable=False, default=True)

    # Self relationship (optional)
    parent = relationship("SQLAccount", remote_side=[so_tai_khoan], backref="children")

    def __repr__(self):
        return f"<SQLAccount {self.so_tai_khoan} - {self.ten_tai_khoan}>"
# File: app/infrastructure/models/sql_accounting_period.py

from sqlalchemy import Column, Integer, String, Date, DateTime
from app.infrastructure.base import Base # Giả sử Base được định nghĩa ở đây hoặc import từ đúng nơi

class SQLAccountingPeriod(Base):
    """
    ORM Model đại diện cho bảng 'accounting_periods'.
    """
    __tablename__ = 'accounting_periods'

    id = Column(Integer, primary_key=True, index=True)
    ten_ky = Column(String(100), nullable=False, unique=True) # Tên kỳ phải là duy nhất
    ngay_bat_dau = Column(Date, nullable=False)
    ngay_ket_thuc = Column(Date, nullable=False)
    trang_thai = Column(String(20), nullable=False, default="Open") # "Open", "Locked"
    ghi_chu = Column(String(512), nullable=True)
    # created_at = Column(DateTime, default=datetime.utcnow)
    # updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
# File: app/infrastructure/models/sql_journal_entry.py

from sqlalchemy import Column, Integer, String, Date, Numeric, ForeignKey
from sqlalchemy.orm import declarative_base, relationship # Import relationship
from app.infrastructure.models.sql_account import SQLAccount # Import để ràng buộc FK
from app.infrastructure.base import Base
# from app.infrastructure.database import Base

class SQLJournalEntryLine(Base):
    """
    ORM Model đại diện cho bảng 'journal_entry_lines' trong cơ sở dữ liệu,
    ánh xạ tới Value Object 'JournalEntryLine' trong Domain.
    """
    __tablename__ = 'journal_entry_lines'

    id = Column(Integer, primary_key=True, index=True)
    journal_entry_id = Column(Integer, ForeignKey('journal_entries.id'), nullable=False) # Khóa ngoại đến bút toán cha
    so_tai_khoan = Column(String(20), ForeignKey('accounts.so_tai_khoan'), nullable=False) # Khóa ngoại đến tài khoản
    no = Column(Numeric(precision=19, scale=4), nullable=False) # Số tiền ghi Nợ
    co = Column(Numeric(precision=19, scale=4), nullable=False) # Số tiền ghi Có
    mo_ta = Column(String(256), nullable=True) # Mô tả dòng (tuỳ chọn)

    # Relationship đến bút toán cha
    journal_entry = relationship("SQLJournalEntry", back_populates="lines")
    # Relationship đến tài khoản
    account = relationship("SQLAccount") # Không cần back_populates nếu không cần truy vấn ngược từ tài khoản

class SQLJournalEntry(Base):
    """
    ORM Model đại diện cho bảng 'journal_entries' trong cơ sở dữ liệu,
    ánh xạ tới Entity 'JournalEntry' trong Domain.
    """
    __tablename__ = 'journal_entries'

    id = Column(Integer, primary_key=True, index=True)
    ngay_ct = Column(Date, nullable=False)
    so_phieu = Column(String(50), nullable=False, unique=True) # Số phiếu phải là duy nhất
    mo_ta = Column(String(512), nullable=True)
    trang_thai = Column(String(20), nullable=False, default="Draft") # Draft, Posted, Locked

    # Relationship đến các dòng bút toán
    lines = relationship("SQLJournalEntryLine", back_populates="journal_entry", cascade="all, delete-orphan")
    # cascade="all, delete-orphan" đảm bảo khi xóa bút toán cha, các dòng con cũng bị xóa
